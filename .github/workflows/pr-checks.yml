name: PR Checks (Basic Checks and Runner)

on:
  workflow_dispatch:

jobs:
  check-js:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Check generated JS
        run: .github/workflows/script/check-js.sh

  check-node-modules:
    name: Check modules up to date
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - name: Check node modules up to date
        run: .github/workflows/script/check-node-modules.sh

  runner-analyze-csharp-autobuild-macos:
    name: Runner macos autobuild C# analyze
    needs: [check-js, check-node-modules]
    strategy:
      matrix:
        os: ['macos-10.15', 'macos-11']
    runs-on: ${{ matrix.os }}

    env:
      ACTIONS_RUNNER_DEBUG: 1
    steps:
      - uses: actions/checkout@v2

      - name: Move codeql-action
        shell: bash
        run: |
          mkdir ../action
          mv * .github ../action/
          mv ../action/tests/multi-language-repo/{*,.github} .
          mv ../action/.github/workflows .github

      - name: Build runner
        run: |
          cd ../action/runner
          npm install
          npm run build-runner

      - name: Initialize dotnet
        run: dotnet restore

      - name: Run init
        run: |
          ../action/runner/dist/codeql-runner-macos init --repository $GITHUB_REPOSITORY --languages csharp --github-url $GITHUB_SERVER_URL --github-auth ${{ github.token }}

      - name: Build code
        shell: bash
        run: |
          ../action/runner/dist/codeql-runner-macos autobuild

      - name: Run analyze
        run: |
          ../action/runner/dist/codeql-runner-macos analyze --repository $GITHUB_REPOSITORY --commit $GITHUB_SHA --ref $GITHUB_REF --github-url $GITHUB_SERVER_URL --github-auth ${{ github.token }}
        env:
          TEST_MODE: true

  
